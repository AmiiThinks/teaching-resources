\documentclass[12pt]{article}
\usepackage{fullpage}

\input{commands}

\begin{document}

\noindent
{\Large\bf AUCSC 460 -- Artificial Intelligence}

\vspace*{1\baselineskip}

\noindent
{\large\bf Assignment 5: Classification}

\vspace*{1\baselineskip}

\noindent
Winter 2016\\
Department of Science\\
University of Alberta, Augustana Faculty\\
{\bf Instructor}: Anna Koop, HB 1-31, akoop@ualberta.ca

\vspace*{1.75\baselineskip}
\hrule

\begin{tabbing}
{\bf Instructor}:\ \ \=\kill
\>{\bf Due}:\'{\em Friday, Apr 8 at 23:55:00 local time}
\\
\>{\bf Worth}:\' 25\% of final grade \\
\>(5 questions worth 5\% each)
\end{tabbing}

\hrule

\vspace*{1.25\baselineskip}

\noindent
{\bf Note}:
If using python, submit a single file called models.py defining the specified functions.

If using another language, submit a zip file with instruction to run.

\subsubsection*{Handwritten digit recognition}

\noindent
In this assignment you will implement simple handwritten digit
recognizers using simple probability models.
We will be using the MNIST data set which you have already seen in Weka or directly from {\texttt http://yann.lecun.com/exdb/mnist/}.

The first step is to go to the course webpage 
and get the files model.mat and show.m.
In Matlab, type ``{\tt load model.mat}.''
This will load the arrays
{\tt digits} ($8\times8\times10$),
{\tt noise} ($1\times7$),
{\tt htrans} ($1\times3$),
and
{\tt vtrans} ($1\times3$).
The array {\tt digits} contains image templates for the digits
1,...,9,0.
To see them, type {\tt show(digits(:,:,}$d${\tt))} for $d=1,...,10$.
There is also a collection of real handwritten
digits in the file data.mat
which contains 1100 examples each digit in an $8\times8\times1100\times10$
array called {\tt data}.

\bigskip

\noindent
{\em Background}:
In this assignment digit images will be represented by $8\times8$
arrays of greyscale numbers, where
1 = black, 2 = dark grey, 3 = light grey, and 4 = white.
For example, the following matrix represents the corresponding image.

\bigskip

\hspace*{1.5cm}
\raisebox{2.5cm}{$\left[\begin{array}{cccccccc}
     1 &     1 &     1 &     2 &     3 &     4 &     4 &     4 \\
     1 &     1 &     2 &     3 &     4 &     2 &     2 &     2 \\
     1 &     1 &     3 &     4 &     2 &     1 &     1 &     1 \\
     1 &     2 &     4 &     4 &     4 &     4 &     2 &     1 \\
     1 &     1 &     2 &     2 &     2 &     2 &     4 &     2 \\
     2 &     1 &     1 &     1 &     2 &     3 &     4 &     2 \\
     4 &     3 &     2 &     2 &     3 &     4 &     2 &     1 \\
     2 &     4 &     4 &     4 &     4 &     2 &     1 &     1
\end{array}\right]$}
\quad
%\epsfxsize=2in\epsfbox{five.eps}

The goal is to implement three probability models that can be used
to generate and recognize images of handwritten digits.
The assignment is split up into three main parts: in each part
you will implement a generator and recognizer for a different
probability model (where each model extends the previous).

%\vspace*{1\baselineskip}
\newpage

\hrule

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{Probability Model 1: Generation}

\input{images/model1}

\bigskip

\noindent
Pick a digit $n$ uniformly at random from among 1,...,9,0
and retrieve its corresponding image template $D$ (an $8\times8$ array).
Given the digit template, each image pixel $o_{ij}$ is generated independently 
by first picking a random noise value $n_{ij}\in\{-3,-2,-1,0,1,2,3\}$
(according to the distribution defined in {\tt noise}),
adding the noise to the corresponding digit template pixel $d_{ij}$
to obtain the raw pixel value, $r_{ij}=d_{ij}+n_{ij}$,
and then thresholding the raw value to obtain the observed image pixel:
\[
o_{ij} \;\;=\;\;\left\{\begin{array}{cll}
r_{ij} & \mbox{ if } & 1\leq r_{ij}\leq4\\
1 & \mbox{ if } & r_{ij} < 1\\
4 & \mbox{ if } & r_{ij} > 4
\end{array}\right.
\]
The {\tt noise} vector gives the probability of obtaining each noise value:
{\tt noise(1)}$=\PP(n_{ij}\!=\!-3)$,
{\tt noise(2)}$=\PP(n_{ij}\!=\!-2)$,
...,
{\tt noise(7)}$=\PP(n_{ij}\!=\!3)$.




%%%%%%%%%%%%
\subsection*{Part 1 \rm(Generating from Model 1---1\%)}

Write a Matlab function ``{\tt gen1}'' that takes two arguments,
{\tt digits} and {\tt noise}, and returns a random image of a 
digit generated by the model outlined above.


\vspace*{1\baselineskip}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\newpage
\hrule

\subsubsection*{Probability Model 1: Recognition}

Given an observed image $O$, we wish to compute the most likely
digit given the image.  This amounts to computing the most likely
digit image template $D$ given $O$
(since digits and their image templates are in a one-to-one correspondence).
Thus, we wish to find

\begin{eqnarray*}
D^* & = & \arg\max_D \; \PP(D|O)
\\
& = & \arg\max_D \; \PP(DO)
\\
& = & \arg\max_D \; \sum_N \PP(DNO)
\\
& = & \arg\max_D \; \sum_N \PP(D) \PP(N) \PP(O|DN)
\\
& = & \arg\max_D \; \PP(D) \sum_{n_{11}=-3}^3\cdots\sum_{n_{88}=-3}^3 \left[\prod_{i=1}^8\prod_{j=1}^8\PP(n_{ij})\right]\left[\prod_{i=1}^8\prod_{j=1}^8\PP(o_{ij}|d_{ij},n_{ij})\right]
\\
& = & \arg\max_D \; \PP(D) \prod_{i=1}^8\prod_{j=1}^8 \sum_{n_{ij}=-3}^3 \PP(n_{ij})\PP(o_{ij}|d_{ij},n_{ij})
\end{eqnarray*}
where
\[
\PP(o_{ij}|d_{ij},n_{ij}) \;\;=\;\;\left\{
\begin{array}{ll}
1 & \begin{array}[t]{l}\mbox{ if } d_{ij}+n_{ij}=o_{ij}\\
                    \mbox{ or } o_{ij} = 1 \mbox{ and } d_{ij}+n_{ij}<1\\
                    \mbox{ or } o_{ij} = 4 \mbox{ and } d_{ij}+n_{ij}>4\\
\rule{0em}{1ex}
    \end{array}
\\
0 & \mbox{ otherwise }
\end{array}
\right.
\]
and $P(D)$ is uniform.
For each digit image template, $D^{(1)},...,D^{(9)},D^{(0)}$,
we can then compute the conditional probability of $D^{(d)}$ given
$O$ by $\PP(D^{(d)}|O)=\PP(D^{(d)}O)/\sum_{d=1,...9,0}\PP(D^{(d)}O)$.


%%%%%%%%%%%%
\subsection*{Part 2 \rm(Recognition with Model 1---2\%)}

Write a Matlab function ``{\tt rec1}'' that takes three arguments,
{\tt obs}, {\tt digits}, and {\tt noise}, where {\tt obs} is
an $8\times8$ image of an observed digit,
and returns {\tt class} and {\tt probs},
where {\tt class} is the digit 1,...,9,0 that is most likely given
{\tt obs}, and {\tt probs} is a $1\times10$ array of the conditional
probabilities of each digit given {\tt obs}.
The classification and conditional probabilities are to be calculated
using the procedures outlined above.
(Note that the conditional probabilities may be near zero or one.)


\vspace*{1\baselineskip}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\newpage
\hrule

\subsubsection*{Probability Model 2: Generation}

The second probability model extends the first by adding a possible 
transformation to the digit templates before generating the final image.
We will consider a small set of simple 
horizontal and vertical shear transformations.
In particular, horizontal shear transformations
will slide the top part of the image template to the left
and the bottom part to the right.
For example, a horizontal shear value of $h=2$ 
will shift the template as follows:

\bigskip

\input{images/shear5}
%\quad
%\raisebox{-1.1ex}{\epsfxsize=2in\epsfbox{shearfive.eps}}

\noindent
Similarly, a vertical shear transformation will
slide the left part of the image
in an opposite direction to the right part.
For example, a vertical shear value of $v=-1$
will shift the template as follows:

\bigskip

\hspace*{2.2em}
\input{images/vshear}
\hspace*{1.49cm}
%\raisebox{2.3ex}{\epsfxsize=2in\epsfbox{shearvfive.eps}}

\bigskip

Generation from this model is similar to before,
except that we introduce an intermediate transformation
step which takes into account both the horizontal and
vertical shears.

\begin{center}
\input{images/model2a}
\end{center}

To generate an image, 
pick a digit $n$ uniformly at random 
and retrieve its corresponding image template $D$.
Then independently pick a random horizontal shear number $h\in\{0,1,2\}$
(according to the distribution defined in {\tt htrans}),
and
a random vertical shear number $v\in\{-1,0,1\}$
(according to the distribution defined in {\tt vtrans}).
Then, given $D$, $h$ and $v$, a warped template $W$ is created according to

\[
w_{ij} \;\;=\;\;\left\{
\begin{array}{ll}
d_{\;t(j,i,v)\;t(i,j,h)}
& \mbox{ if both $1\leq t(j,i,v)\leq 8$ and $1\leq t(i,j,h)\leq 8$}
\\[2ex]
1 & \mbox{ otherwise}
\end{array}
\right.
\]
where
%
\begin{eqnarray*}
t(j,i,v) & = & i+round(v(5-j)/4)
\\
t(i,j,h) & = & j+round(h(5-i)/4)
\end{eqnarray*}
%
Note that the
{\tt htrans} vector gives the probability of obtaining each 
horizontal shear value:
{\tt htrans(1)}$=\PP(h\!=\!0)$,
{\tt htrans(2)}$=\PP(h\!=\!1)$,
{\tt htrans(3)}$=\PP(h\!=\!2)$;
and
the {\tt vtrans} vector gives the probability of obtaining each 
vertical shear value:
{\tt vtrans(1)}$=\PP(v\!=\!-1)$,
{\tt vtrans(2)}$=\PP(v\!=\!0)$,
{\tt vtrans(3)}$=\PP(v\!=\!1)$.

Finally, given the warped template, each image pixel $o_{ij}$ is generated 
independently as before by
first picking a random noise value $n_{ij}$ and adding it to
$w_{ij}$ to obtain a raw pixel value $r_{ij}=w_{ij}+n_{ij}$,
and then thresholding between 1 and 4 to obtain the final observed value.
%The overall generative model is summarized in the following diagram.
 
%%%%%%%%%%%%
\subsection*{Part 3 \rm(Generating from Model 2---1\%)}
 
Write a Matlab function ``{\tt gen2}'' that takes four arguments,
{\tt digits}, {\tt noise}, {\tt htrans} and {\tt vtrans}, 
and returns a random image of a 
digit generated by the model outlined above.


\vspace*{1\baselineskip}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\newpage
\hrule

\subsubsection*{Probability Model 2: Recognition}

\begin{eqnarray*}
D^*
& = & \arg\max_D \; \PP(DO)
\\
& = & \arg\max_D \; \sum_h\sum_v\sum_N \PP(D)\PP(h)\PP(v)\PP(N)\PP(O|D,h,v,N)
\\
& = & \arg\max_D \; \PP(D)\sum_h\PP(h)\sum_v\PP(v)\sum_{n_{11}}\cdots\sum_{n_{88}} 
\left[\prod_i\prod_j\PP(n_{ij})\right]
\left[\prod_i\prod_j \PP(o_{ij}|d_{\;t(j,i,v)\;t(i,j,h)\;},n_{ij}) \right]
\\
& = & \arg\max_D \; \PP(D)\sum_h\PP(h)\sum_v\PP(v)
\prod_i\prod_j \sum_{n_{ij}} \PP(n_{ij})\PP(o_{ij}|d_{\;t(j,i,v)\;t(i,j,h)\;},n_{ij})
\end{eqnarray*}

where %$t(i,j,s)=j+\mbox{round}(s(5-i)/4)$
%and 
$\PP(o_{ij}|d_{\;t(j,i,v)\;t(i,j,h)\;},n_{ij})$ is determined as before.


%%%%%%%%%%%%
\subsection*{Part 4 \rm(Recognition with Model 2---2\%)}


Write a Matlab function ``{\tt rec2}'' that takes five arguments,
{\tt obs}, {\tt digits}, {\tt noise}, {\tt htrans} and {\tt vtrans},
%where {\tt obs} is an $8\times8$ image of an observed digit,
and returns {\tt class} and {\tt probs},
where {\tt class} is the digit 1,...,9,0 that is most likely given
{\tt obs}, and {\tt probs} is a $1\times10$ array of the conditional
probabilities of each digit given {\tt obs}.
The classification and conditional probabilities are to be calculated
using the procedures outlined above.


\vspace*{1\baselineskip}


\newpage
\hrule

%%%%%%%%%%%%
\subsubsection*{Probability Model 3: Your own improved model}

%\subsection*{Bonus \rm(2\%)}

Design a probability model that extends either Model 1 or Model 2,
and achieves better recognition performance (than both models) on the
test examples in {\tt data}.
Note that the 1100 images in {\tt data} forms a very large set
and it would probably take too long to test your model on every image.
Instead, you can (repeatedly) test the model on 25 randomly chosen
images for each digit.
(The TA will apply a similar test to verify that your model is indeed
an improvement.)


%%%%%%%%%%%%
\subsection*{Part 5 \rm(Derivation of Model 3---1\%)}

Describe your extended probability model.
Explain how the data can be generated from your model,
and derive the formulas needed for recognition
and for calculating the conditional probabilities of digits given images
in your model.
Please typeset your answer neatly (in whatever typesetting tool you prefer),
and convert it to PDF format for submission.
Submit the brief write-up in a file called note3.pdf.


%%%%%%%%%%%%
\subsection*{Part 6 \rm(Generation with Model 3---1\%)}

Write a Matlab function ``{\tt gen3}'' that takes
{\tt digits}, {\tt noise} and some other parameters,
and returns a random image generated by your extended model.


%%%%%%%%%%%%
\subsection*{Part 7 \rm(Recognition with Model 3---2\%)}

Write a Matlab function ``{\tt rec3}'' that takes
{\tt obs}, {\tt digits}, {\tt noise} and some other parameters,
and returns {\tt class} and {\tt probs},
where {\tt class} is the digit 1,...,9,0 that is most likely given
{\tt obs}, and {\tt probs} is a $1\times10$ array of the conditional
probabilities of each digit given {\tt obs}.

\end{document}